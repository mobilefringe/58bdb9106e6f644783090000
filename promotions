<div class="promotions_header">
    <div class="site_container mobile_padding">
        <div class="row">
            <div class="col-md-12">
                <h3 class="store_list_header center">Promotions</h3>
            </div>   
        </div>
        <div class="mobile_padding">
            <div class="row">
                <div class="col-md-4">
                    <div class="promotions_header_container store_search" >
                        <label class="">
                            <input type="text" placeholder="Search" id="store_search" />
                            <img src="//codecloud.cdn.speedyrails.net/sites/58bdb9106e6f644783090000/image/png/1488985579000/search-512.png" class="pull-right" id="store_search_img" alt="">
                            <i id="close_search_results" class="fa fa-times-circle hidden_now"></i>
                        </label>
                        <div class="search_results" id="store_search_results"></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="promotions_header_container dropdown category_selector">
                        <a class="" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">Sort by Category <span class="dropdown_arrow"><img src="//codecloud.cdn.speedyrails.net/sites/58bdb9106e6f644783090000/image/png/1489097373000/Expand Arrow.png" alt=""></span></a>
                        <ul class="dropdown-menu cat_list" aria-labelledby="dropdownMenu1" id="category_select">
                            <script id="category_select_template" type="x-tmpl-mustache/text">
    				            <li class="show_cat_stores" data-id="{{id}}">{{name}}</li>
    				        </script>
                        </ul>
                    </div>
                </div>
                <div class="col-md-4">
                    <a href="/directory">
                        <div class="promotions_header_container directory_btn">View Directory</div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="site_container mobile_padding">
    <div class="fluid_row">
        <div class="mobile_padding">
            <div class="row">
                <div id="promos_container" class="promos_page">
                    <script id="promos_template" type="x-tmpl-mustache/text">
                        <div class="col-sm-6 col-md-4 margin_50 cats_row" data-cat="{{cat_list}}">
                            <div class="promo_container" value="{{categories}}">
                                <div class="promo_img_container">
                                    <img src="{{image_url}}" alt="Promotion" class="promo_img" />
                                </div>
                                <div class="details">
                                    <h3 class="details_header">{{name_short}}</h3>
                                    <h3 class="details_store_name">{{store_name}}</h3>
                                    <h3 class="jobs_publish_date"><i class="fa fa-calendar"></i> &nbsp;{{dates}}</h3>    
                                </div>
                                <a href="/promotions/{{slug}}" class="read_more_btn">Read More</a>
                            </div>
                        </div>
                    </script>
                </div>
                <div class="col-md-12">
                    <h3 id="load_more" class="" data-count="10">LOAD MORE</h3>
                </div>
                <div class="col-md-12">
                    <h3 id="no_promos" class="hidden_now">There are currently no promotions available, please check back again later.</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="margin_40"></div>
</div>
<script>
    $(document).ready(function(e){
        init(e);
        function renderAll(){
            var promotions = getPromotionsList().sortBy(function(o){ return o.end_date });
            var published_promos = [];
            var cat_list = [];
            var cat_names = [];
            $.each(promotions, function(key, val){
                try {
                    today = moment();
                    webDate = moment(val.show_on_web_date)
                    if (today.tz(getPropertyTimeZone()) >= webDate.tz(getPropertyTimeZone())) {
                        published_promos.push(val);
                    }
                }
                catch (err) {
                    console.log(err);
                }
            });
            cat_list = _.filter(getStoreCategories(), function(o) {
                return o.store_ids;
            });
            
            var increment = 10;
            var paginated_promos = published_promos.slice(0, increment);
            
            $("#load_more").click(function(){
                var current_count = $("#load_more").attr('data-count');
                console.log("current_count", current_count);
                $("#load_more").attr('data-count', current_count+increment)
                paginated_promos = published_promos.slice(0, current_count+increment);
                renderPromotions("#promos_container","#promos_template", paginated_promos);
                if(paginated_promos.length == published_promos.length)
            })
            
            
            if(paginated_promos.length > 0){
                console.log("before promo render")
                renderPromotions("#promos_container","#promos_template", paginated_promos);
            } else {
                $('#no_promos').show()
            }
            
            // var category_info = [];
            // $.each(cat_list, function(key, val){
            //     var category = getCategoryDetails(val);
            //     category_info.push(category);
            // });
            // var cat_list = _.uniq(category_info, function(o){ return o.name; });
            renderGeneral("#category_select", "#category_select_template", cat_list);
            $('#category_select').prepend('<li class="show_cat_stores" data-id="9999">DOMAIN NORTHSIDE</li>');
            $('#category_select').prepend('<li class="show_cat_stores" data-id="All">ALL</li>');

            show_content();
            store_search();
            show_cat_stores();
            $('#top_nav_promotions').addClass('active_yellow')
        }
        loadMallDataCached(renderAll); 
    });
    
    function show_cat_stores(){
        $('.show_cat_stores').click(function(e){
            var cat_id = $(this).attr('data-id');
            var rows = $('.cats_row');
            if(cat_id != "All") {
                rows.hide();
                $('#cat_name').text($(this).text());
                $('#cat_name').css('display', 'block');
                $.each(rows, function(i, val){
                    var cat_array = val.getAttribute('data-cat').split(',');
                    if ($.inArray(cat_id, cat_array) >= 0){
                        $(val).show();
                    }
                });
            } else {
                rows.show();
                $.each($('.store_initial'), function(i, val){
                    if ($(val).text().length > 0){
                        $(val).show();
                    } 
                });
                $('#cat_name').hide();    
            }
            $('.dropdown-menu .cat_list').css('display', 'none');
            $('html, body').animate({scrollTop : 0},800);
            e.preventDefault();
        });
    }
</script>